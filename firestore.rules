rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        request.auth.token.role == 'admin';
    }

    function isAgency() {
      return isAuthenticated() &&
        request.auth.token.role == 'agency';
    }

    function isCandidate() {
      return isAuthenticated() &&
        request.auth.token.role == 'candidate';
    }

    // Jobs - Public read, Admin write
    match /jobs/{jobId} {
      allow read: if resource.data.status == 'active' || isAdmin();
      allow write: if isAdmin();
    }

    // Candidates - Restricted access
    match /candidates/{candidateId} {
      // Admins can read/write all
      allow read, write: if isAdmin();

      // Candidates can read their own (after OTP)
      allow read: if isCandidate() &&
        resource.data.firebase_uid == request.auth.uid;

      // Agencies can read assigned only
      allow read: if isAgency() &&
        candidateId in get(/databases/$(database)/documents/agencies/$(request.auth.uid)).data.assigned_candidates;

      // Public stateless access via tracking token (handled by Cloud Function)
    }

    // Assessments - Restricted
    match /assessments/{assessmentId} {
      allow read, write: if isAdmin();

      // Candidates can read/write their own during exam
      allow read, write: if isCandidate() &&
        resource.data.candidate_id == request.auth.uid &&
        resource.data.status == 'in_progress';
    }

    // Agencies - Restricted
    match /agencies/{agencyId} {
      allow read, write: if isAdmin();
      allow read: if isAgency() && agencyId == request.auth.uid;
    }
  }
}

